<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydroponic Control Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .control-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .control-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .control-card h2 {
            margin: 0;
            font-size: 18px;
            color: #555;
        }
        .control-card button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        .control-card button.off {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <h1>Hydroponic Control Panel</h1>
    <div class="control-container" id="control-container">
        <!-- Kontrol akan diisi oleh JavaScript -->
    </div>

    <script>
        const GITHUB_TOKEN = "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"; // Replace with your new token
        const REPO_OWNER = "patriotsensetech";
        const REPO_NAME = "hydroponic";
        const FILE_PATH = "docs/data.json";
        const API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;

        // Fungsi untuk mengambil data terbaru dari GitHub
        async function fetchLatestData() {
            try {
                const response = await fetch(API_URL, {
                    headers: { Authorization: `token ${GITHUB_TOKEN}` },
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                // Periksa apakah field 'content' ada dan valid
                if (!data.content) {
                    throw new Error("Invalid response: 'content' field is missing");
                }

                return {
                    sha: data.sha,
                    content: JSON.parse(atob(data.content)),
                };
            } catch (error) {
                console.error("Error fetching data:", error);
                return null;
            }
        }

        // Fungsi untuk mengupdate data di GitHub
        async function updateData(newData, sha) {
            const encodedContent = btoa(JSON.stringify(newData, null, 2));
            try {
                const response = await fetch(API_URL, {
                    method: "PUT",
                    headers: {
                        Authorization: `token ${GITHUB_TOKEN}`,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        message: "Update data.json via control panel",
                        content: encodedContent,
                        sha: sha,
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                console.log("Data updated successfully:", newData);
                return true;
            } catch (error) {
                console.error("Error updating data:", error);
                return false;
            }
        }

        // Fungsi untuk membuat tombol kontrol
        function createControl(key, value) {
            const card = document.createElement('div');
            card.className = 'control-card';
            const button = document.createElement('button');
            button.textContent = value === 1 ? 'ON' : 'OFF';
            button.classList.toggle('off', value === 0);

            button.addEventListener('click', async () => {
                const latestData = await fetchLatestData();
                if (!latestData) return;

                // Toggle nilai
                latestData.content[key] = latestData.content[key] === 1 ? 0 : 1;

                // Update data di GitHub
                const success = await updateData(latestData.content, latestData.sha);
                if (success) {
                    button.textContent = latestData.content[key] === 1 ? 'ON' : 'OFF';
                    button.classList.toggle('off', latestData.content[key] === 0);
                }
            });

            card.innerHTML = `<h2>${key.replace(/_/g, ' ')}</h2>`;
            card.appendChild(button);
            return card;
        }

        // Fungsi untuk memuat kontrol
        async function loadControls() {
            const latestData = await fetchLatestData();
            if (!latestData) return;

            const container = document.getElementById('control-container');
            container.innerHTML = '';

            // Buat kontrol untuk katup dan pompa
            const controls = ['katup_1', 'katup_2', 'katup_3', 'katup_4', 'pompa'];
            controls.forEach(key => {
                const control = createControl(key, latestData.content[key]);
                container.appendChild(control);
            });
        }

        // Muat kontrol saat halaman dimuat
        loadControls();
    </script>
</body>
</html>
